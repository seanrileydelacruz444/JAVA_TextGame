package game;


import javax.swing.*;
import javax.swing.border.TitledBorder;
import java.awt.*;
import java.awt.event.*;
import java.util.*;
import java.awt.image.BufferedImage;

class BattleScenePanel extends JPanel implements ActionListener {
    private JFrame frame;
    private ArrayList<String> characterNames;
    private JLabel[] characterDialogueLabels = new JLabel[2];
    private javax.swing.Timer battleTimer;

    private final ArrayList<Point> stars = new ArrayList<>();
    private final ArrayList<Integer> starSpeeds = new ArrayList<>();

    private JLabel[] characterHPLabels;
    private JLabel monsterHPLabel;

    public BattleScenePanel(JFrame frame, ArrayList<String> characterNames) {
        this.frame = frame;
        this.characterNames = characterNames;
        setLayout(new BorderLayout());
        setBackground(Color.BLACK);

        testImageLoading();

        generateStars(150);

        setupBattleUI();

        battleTimer = new javax.swing.Timer(50, this);
        battleTimer.start();
    }

    private void testImageLoading() {
        System.out.println("=== IMAGE LOADING DEBUG ===");
        System.out.println("Working Directory: " + System.getProperty("user.dir"));

        String[] testChars = {"Dorothy", "Quinn", "Noah", "Darwin", "Ace"};
        for (String charName : testChars) {
            String path = "images/" + charName.toLowerCase() + ".jpg";
            java.io.File file = new java.io.File(path);
            System.out.println(charName + " - " + path + " - Exists: " + file.exists() + " - Absolute: " + file.getAbsolutePath());
        }
        System.out.println("=== END DEBUG ===");
    }

    private void generateStars(int count) {
        Random rand = new Random();
        for (int i = 0; i < count; i++) {
            stars.add(new Point(rand.nextInt(900), rand.nextInt(600)));
            starSpeeds.add(1 + rand.nextInt(3));
        }
    }

    private void setupBattleUI() {
        // Information sa taas
        JPanel topPanel = new JPanel(new BorderLayout());
        topPanel.setOpaque(false);
        topPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        JLabel battleLabel = new JLabel("BATTLE IN PROGRESS!", SwingConstants.CENTER);
        battleLabel.setFont(new Font("Monospaced", Font.BOLD, 20));
        battleLabel.setForeground(new Color(255, 100, 100));
        topPanel.add(battleLabel, BorderLayout.CENTER);

        JButton backButton = new JButton("BACK TO SELECTION");
        backButton.setFont(new Font("Monospaced", Font.PLAIN, 12));
        backButton.setBackground(new Color(60, 60, 60));
        backButton.setForeground(Color.WHITE);
        backButton.addActionListener(e -> {
            BattlePanel battlePanel = new BattlePanel(frame);
            frame.setContentPane(battlePanel);
            frame.revalidate();
            frame.repaint();
        });
        topPanel.add(backButton, BorderLayout.EAST);

        add(topPanel, BorderLayout.NORTH);

        // Battle field the center
        JPanel centerPanel = new JPanel(new GridLayout(1, 2, 20, 0));
        centerPanel.setOpaque(false);
        centerPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        // Character nga side
        JPanel characterPanel = createCharacterPanel();
        centerPanel.add(characterPanel);

        // Enemy nga side
        JPanel monsterPanel = createMonsterPanel();
        centerPanel.add(monsterPanel);

        add(centerPanel, BorderLayout.CENTER);

        //Skill buttons
        JPanel actionPanel = createActionPanel();
        add(actionPanel, BorderLayout.SOUTH);
    }

    private JPanel createActionPanel() {
        JPanel panel = new JPanel(new GridLayout(2, 1, 10, 10));
        panel.setOpaque(false);
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // action panel sa 2 characters
        for (int charIndex = 0; charIndex < characterNames.size(); charIndex++) {
            String characterName = characterNames.get(charIndex);
            String[] skills = getCharacterSkills(characterName);

            JPanel charActionPanel = new JPanel(new FlowLayout());
            charActionPanel.setBackground(new Color(40, 40, 80, 220));
            charActionPanel.setBorder(BorderFactory.createTitledBorder(
                    BorderFactory.createLineBorder(new Color(100, 100, 255), 2),
                    characterName + "'s Skills",
                    TitledBorder.CENTER, TitledBorder.TOP,
                    new Font("Monospaced", Font.BOLD, 12), new Color(200, 200, 255)
            ));

            if (skills != null) {
                // Add "Attack" as basic skill
                JButton attackBtn = new JButton("ATTACK");
                attackBtn.setFont(new Font("Monospaced", Font.BOLD, 10));
                attackBtn.setBackground(new Color(80, 80, 120));
                attackBtn.setForeground(Color.WHITE);
                attackBtn.setPreferredSize(new Dimension(100, 35));
                attackBtn.setToolTipText("Basic attack - Deals normal damage to enemy");
                charActionPanel.add(attackBtn);


                // Add character-specific skills with tooltips
                for (String skill : skills) {
                    JButton skillBtn = new JButton("<html><center>" + skill + "</center></html>");
                    skillBtn.setFont(new Font("Monospaced", Font.BOLD, 8));
                    skillBtn.setBackground(new Color(70, 70, 110));
                    skillBtn.setForeground(Color.WHITE);
                    skillBtn.setPreferredSize(new Dimension(100, 35));
                    charActionPanel.add(skillBtn);
                    skillBtn.addActionListener(e -> showSkillDialogue(characterName, skill));
                }
            }

            panel.add(charActionPanel);
        }

        return panel;
    }

    private JPanel createCharacterPanel() {
        JPanel panel = new JPanel(new GridLayout(2, 1, 10, 10));
        panel.setOpaque(false);
        panel.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(new Color(0, 150, 255), 3),
                "YOUR TEAM",
                TitledBorder.CENTER, TitledBorder.TOP,
                new Font("Monospaced", Font.BOLD, 16), new Color(100, 200, 255)
        ));

        characterHPLabels = new JLabel[2];

        for (int i = 0; i < characterNames.size(); i++) {
            String characterName = characterNames.get(i);
            JPanel charCard = new JPanel(new BorderLayout(10, 10));
            charCard.setBackground(new Color(40, 40, 80, 220));
            charCard.setBorder(BorderFactory.createLineBorder(new Color(100, 150, 255), 2));

            // Character image
            JLabel imageLabel = createImageForCharacter(characterName);

            // Character info
            JPanel infoPanel = new JPanel(new GridLayout(3, 1));
            infoPanel.setBackground(new Color(40, 40, 80, 220));

            JLabel nameLabel = new JLabel(characterName, SwingConstants.CENTER);
            nameLabel.setFont(new Font("Monospaced", Font.BOLD, 14));
            nameLabel.setForeground(new Color(200, 200, 255));

            characterHPLabels[i] = new JLabel("HP: 150/150", SwingConstants.CENTER);
            characterHPLabels[i].setFont(new Font("Monospaced", Font.BOLD, 12));
            characterHPLabels[i].setForeground(new Color(100, 255, 100));

            //fdialogue
            characterDialogueLabels[i] = new JLabel("", SwingConstants.CENTER);
            characterDialogueLabels[i].setFont(new Font("Monospaced", Font.ITALIC, 15));
            characterDialogueLabels[i].setForeground(new Color(255, 255, 150));
            characterDialogueLabels[i].setPreferredSize(new Dimension(150, 30));
            //

            infoPanel.add(nameLabel);
            infoPanel.add(characterHPLabels[i]);
            //fdialogue
            infoPanel.add(characterDialogueLabels[i]);
            //

            charCard.add(imageLabel, BorderLayout.WEST);
            charCard.add(infoPanel, BorderLayout.CENTER);

            panel.add(charCard);
        }

        return panel;
    }

    private JLabel createImageForCharacter(String characterName) {
        JLabel imageLabel = new JLabel();
        imageLabel.setPreferredSize(new Dimension(80, 80));
        imageLabel.setHorizontalAlignment(SwingConstants.CENTER);
        imageLabel.setBorder(BorderFactory.createLineBorder(Color.WHITE, 2));

        // Ang sa image huhu
        boolean imageLoaded = false;

        // Orig code for image showing
        String relativePath = "images/" + characterName.toLowerCase() + ".jpg";
        System.out.println("Trying relative path: " + relativePath);

        try {
            java.io.File file = new java.io.File(relativePath);
            if (file.exists()) {
                ImageIcon icon = new ImageIcon(relativePath);
                if (icon.getImage() != null) {
                    Image scaledImage = icon.getImage().getScaledInstance(80, 80, Image.SCALE_SMOOTH);
                    imageLabel.setIcon(new ImageIcon(scaledImage));
                    imageLoaded = true;
                    System.out.println("✓ SUCCESS with relative path: " + characterName);
                }
            }
        } catch (Exception e) {
            System.out.println("✗ Relative path failed: " + e.getMessage());
        }

        // if ever dili mo gana ang first method
        if (!imageLoaded) {
            System.out.println("Using GUARANTEED fallback for: " + characterName);

           // colored panel if ever dili mo gawas ang image
            JPanel colorPanel = new JPanel();
            colorPanel.setPreferredSize(new Dimension(80, 80));
            colorPanel.setBackground(getCharacterColor(characterName));
            colorPanel.setLayout(new BorderLayout());
            colorPanel.setBorder(BorderFactory.createLineBorder(Color.WHITE, 2));

            JLabel textLabel = new JLabel(getCharacterAbbreviation(characterName), SwingConstants.CENTER);
            textLabel.setFont(new Font("Monospaced", Font.BOLD, 16));
            textLabel.setForeground(Color.WHITE);
            colorPanel.add(textLabel, BorderLayout.CENTER);

            // Convert ang JPanel into an image nya icon
            BufferedImage bufferedImage = new BufferedImage(80, 80, BufferedImage.TYPE_INT_RGB);
            Graphics2D g2d = bufferedImage.createGraphics();
            colorPanel.print(g2d);
            g2d.dispose();
            imageLabel.setIcon(new ImageIcon(bufferedImage));
        }

        return imageLabel;
    }

    private String getCharacterAbbreviation(String characterName) {
        switch (characterName) {
            case "Dorothy": return "ARCH";
            case "Quinn": return "NURSE";
            case "Noah": return "IT";
            case "Darwin": return "ENG";
            case "Ace": return "PSY";
            default: return "CHAR";
        }
    }

    private Color getCharacterColor(String characterName) {
        switch (characterName) {
            case "Dorothy": return new Color(139, 69, 19);
            case "Quinn": return new Color(220, 20, 60);
            case "Noah": return new Color(255, 140, 0);
            case "Darwin": return new Color(40, 40, 40);
            case "Ace": return new Color(50, 205, 50);
            default: return new Color(60, 60, 120);
        }
    }

    private JPanel createMonsterPanel() {
        JPanel monsterPanel = new JPanel(new BorderLayout()) {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                Graphics2D g2d = (Graphics2D) g;

                int panelWidth = getWidth();
                int panelHeight = getHeight();

                int monsterWidth = 180;
                int monsterHeight = 160;
                int monsterX = (panelWidth - monsterWidth) / 2;
                int monsterY = (panelHeight - monsterHeight) / 2 + 10;


                MonsterDrawer.drawMonster(g2d, monsterX, monsterY, monsterWidth, monsterHeight, false);
            }
        };
        monsterPanel.setOpaque(false);
        monsterPanel.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(new Color(255, 100, 100), 3),
                "ENEMY",
                TitledBorder.CENTER, TitledBorder.TOP,
                new Font("Monospaced", Font.BOLD, 16), new Color(255, 150, 150)
        ));

        // Monster stats panel sa ubos
        JPanel statsPanel = new JPanel(new GridLayout(2, 1));
        statsPanel.setOpaque(false);
        statsPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        JLabel nameLabel = new JLabel("SCHOOLWORKS MONSTER", SwingConstants.CENTER);
        nameLabel.setFont(new Font("Monospaced", Font.BOLD, 16));
        nameLabel.setForeground(new Color(255, 100, 100));

        monsterHPLabel = new JLabel("HP: 1000/1000", SwingConstants.CENTER);
        monsterHPLabel.setFont(new Font("Monospaced", Font.BOLD, 14));
        monsterHPLabel.setForeground(new Color(255, 150, 150));

        statsPanel.add(nameLabel);
        statsPanel.add(monsterHPLabel);

        monsterPanel.add(statsPanel, BorderLayout.SOUTH);

        return monsterPanel;
    }

    @Override
    protected void paintComponent(Graphics g) {
        super.paintComponent(g);
        Graphics2D g2d = (Graphics2D) g;


        g2d.setColor(Color.BLACK);
        g2d.fillRect(0, 0, getWidth(), getHeight());

        g2d.setColor(Color.WHITE);
        for (Point star : stars) {
            g2d.fillRect(star.x, star.y, 2, 2);
        }
    }

    @Override
    public void actionPerformed(ActionEvent e) {

        Random rand = new Random();
        for (int i = 0; i < stars.size(); i++) {
            Point star = stars.get(i);
            star.y += starSpeeds.get(i);
            if (star.y > getHeight()) {
                star.y = 0;
                star.x = rand.nextInt(getWidth());
            }
        }
        repaint();
    }

    private String[] getCharacterSkills(String characterName) {
        switch (characterName) {
            case "Dorothy": return new String[]{"T SQUARE", "COMPASS", "SUCCESSFUL FLOOR PLAN"};
            case "Quinn": return new String[]{"FIRST AID KIT", "SPRAY BOTTLE", "SYRINGE ATTACK"};
            case "Noah": return new String[]{"CELLPHONE", "CALL VIRUS", "TRANSFORMATION"};
            case "Darwin": return new String[]{"SURVEY CAMERA", "HEAVY CALCULATIONS", "HARD HATS"};
            case "Ace": return new String[]{"PSYCHOLOGY BOOK", "UNO REVERSE CARD", "EXISTENTIAL CRISIS"};
            default: return new String[]{"ATTACK", "DEFEND"};
        }
    }

    private void showSkillDialogue(String characterName, String skill) {
        int charIndex = characterNames.indexOf(characterName);

        if (charIndex != -1)
        {
            String dialogue = "";
            switch (characterName) {
                case "Dorothy" -> {
                    dialogue = switch (skill) {
                        case "T-SQUARE" -> "Let me straighten out your crooked intentions!";
                        case "COMPASS" -> "I'll circle your weaknesses until there's no escape!";
                        case "SUCCESSFUL FLOOR PLAN" -> "This blueprint ends with your defeat!";
                        default -> "Time to demolish your plans!";
                    };
                }
                case "Quinn" -> {
                    dialogue = switch (skill) {
                        case "FIRST AID KIT" -> "Healing allies!";
                        case "SPRAY BOTTLE" -> "Let me disinfect this situation!";
                        case "SYRINGE ATTACK" -> "This injection will cure your hostility!";
                        default -> "Time for some medical intervention!";
                    };
                }
                case "Noah" -> {
                    dialogue = switch (skill) {
                        case "CELLPHONE" -> "Let me scroll through your system vulnerabilities!";
                        case "CALL VIRUS" -> "We've got a bug to exterminate over here!";
                        case "TRANSFORMATION" -> "Watch me upgrade my attack protocols!";
                        default -> "System override initiated!";
                    };
                }
                case "Darwin" -> {
                    dialogue = switch (skill) {
                        case "SURVEY CAMERA" -> "Capturing all your structural flaws!";
                        case "HEAVY CALCULATIONS" -> "My equations predict your imminent collapse!";
                        case "HARD HATS" -> "Safety first!";
                        default -> "Engineering precision strike engaged!";
                    };
                }
                case "Ace" -> {
                    dialogue = switch (skill) {
                        case "PSYCHOLOGY BOOK" -> "Chapter one: How to defeat overconfident monsters!";
                        case "UNO REVERSE CARD" -> "Reversing attack!";
                        case "EXISTENTIAL CRISIS" -> "What if... you were never meant to win?";
                        default -> "Engineering power!";
                    };
                }
            }

            System.out.println("=== " + characterName + " uses " + skill + "! ===");
            System.out.println(characterName + ": '" + dialogue + "'");
            System.out.println("Monster: 'Ouch! That hurt! Your grades will go down with you!'");
            System.out.println("==========================");

            characterDialogueLabels[charIndex].setText("<html><center>" + dialogue + "</center></html>");

            new javax.swing.Timer(3000, e -> {
                characterDialogueLabels[charIndex].setText("");
                ((javax.swing.Timer)e.getSource()).stop();
            }).start();
        }
    }
}
